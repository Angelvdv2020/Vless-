<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - NoryxVPN</title>
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <a href="/" class="logo">NoryxVPN</a>
      <button class="mobile-menu-toggle" onclick="document.querySelector('nav').classList.toggle('open')">&#9776;</button>
      <nav>
        <ul>
          <li><a href="/cabinet" class="active">–ö–∞–±–∏–Ω–µ—Ç</a></li>
          <li><a href="/tariffs">–¢–∞—Ä–∏—Ñ—ã</a></li>
          <li><a href="/referral">–†–µ—Ñ–µ—Ä–∞–ª–∫–∞</a></li>
          <li><a href="/apps">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a></li>
          <li><a href="/support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a></li>
          <li><a href="#" class="btn btn-secondary btn-sm" onclick="Auth.logout()">–í—ã–π—Ç–∏</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:2rem;">
      <div>
        <h1 style="margin-bottom:0.25rem;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p id="userEmail" style="margin:0;"></p>
      </div>
      <div style="display:flex;gap:0.75rem;">
        <a href="/tariffs" class="btn btn-primary">–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
        <button class="btn btn-success" id="trialBtn" style="display:none;" onclick="activateTrial()">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</button>
      </div>
    </div>

    <div class="stats" id="profileStats" style="margin-bottom:2rem;">
      <div class="stat-card"><div class="stat-number" id="statBalance">0 &#8381;</div><div class="stat-label">–ë–∞–ª–∞–Ω—Å</div></div>
      <div class="stat-card"><div class="stat-number" id="statSubs">0</div><div class="stat-label">–ü–æ–¥–ø–∏—Å–æ–∫</div></div>
      <div class="stat-card"><div class="stat-number" id="statReferrals">---</div><div class="stat-label">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div></div>
      <div class="stat-card"><div class="stat-number" id="statDays">---</div><div class="stat-label">–î–Ω–µ–π –¥–æ –∫–æ–Ω—Ü–∞</div></div>
    </div>

    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab(this,'subsTab')">–ü–æ–¥–ø–∏—Å–∫–∏</button>
      <button class="tab-btn" onclick="switchTab(this,'paymentsTab')">–ü–ª–∞—Ç–µ–∂–∏</button>
      <button class="tab-btn" onclick="switchTab(this,'profileTab')">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <div id="subsTab">
      <div id="subsList"><div class="loading-spinner"><div class="spinner"></div></div></div>
    </div>

    <div id="paymentsTab" style="display:none;">
      <div id="paymentsList"><div class="loading-spinner"><div class="spinner"></div></div></div>
    </div>

    <div id="profileTab" style="display:none;">
      <div class="card" style="max-width:500px;">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="profileEmail" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input type="text" class="form-input" id="profileUsername">
        </div>
        <div class="form-group">
          <label class="form-label">Telegram ID</label>
          <input type="text" class="form-input" id="profileTgId" placeholder="–í–∞—à Telegram ID">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="renewModal">
    <div class="modal">
      <h3>–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h3>
      <p style="margin-bottom:1rem;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ –ø–µ—Ä–∏–æ–¥:</p>
      <div style="margin-bottom:1rem;">
        <div class="tab-nav" style="border-bottom:none;margin-bottom:0.5rem;">
          <button class="tab-btn active" onclick="setRenewPeriod(this,'monthly')">1 –º–µ—Å.</button>
          <button class="tab-btn" onclick="setRenewPeriod(this,'quarterly')">3 –º–µ—Å.</button>
          <button class="tab-btn" onclick="setRenewPeriod(this,'yearly')">1 –≥–æ–¥</button>
        </div>
      </div>
      <div id="renewTariffs"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('renewModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-section"><h4>NoryxVPN</h4><p style="color:var(--text-muted);">–ë—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π VPN.</p></div>
    </div>
    <div class="footer-bottom"><p>NoryxVPN. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p></div>
  </footer>

  <script src="/assets/app.js"></script>
  <script>
    var renewSubId = '';
    var renewPeriod = 'monthly';
    var renewTariffsCache = [];

    var priceFields = {
      monthly: 'price_monthly',
      quarterly: 'price_quarterly',
      yearly: 'price_yearly'
    };

    var periodNames = {
      monthly: '30 –¥–Ω.',
      quarterly: '90 –¥–Ω.',
      yearly: '365 –¥–Ω.'
    };

    function switchTab(btn, tabId) {
      document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      ['subsTab','paymentsTab','profileTab'].forEach(function(id) {
        document.getElementById(id).style.display = id === tabId ? '' : 'none';
      });
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    async function loadCabinet() {
      if (!Auth.requireAuth()) return;

      try {
        var results = await Promise.all([
          API.get('/api/auth/profile'),
          API.get('/api/subscriptions')
        ]);
        var profile = results[0];
        var subs = results[1];

        document.getElementById('userEmail').textContent = profile.email;
        document.getElementById('statBalance').innerHTML = (profile.balance || 0) + ' &#8381;';
        document.getElementById('profileEmail').value = profile.email;
        document.getElementById('profileUsername').value = profile.username || '';
        document.getElementById('profileTgId').value = profile.telegram_id || '';

        if (!profile.trial_used) {
          document.getElementById('trialBtn').style.display = '';
        }

        var activeSubs = subs.filter(function(s) { return s.status === 'active' || s.status === 'trial'; });
        document.getElementById('statSubs').textContent = activeSubs.length;

        if (activeSubs.length > 0) {
          var nearestExpiry = activeSubs.reduce(function(min, s) {
            return new Date(s.expires_at) < new Date(min.expires_at) ? s : min;
          });
          document.getElementById('statDays').textContent = daysUntil(nearestExpiry.expires_at);
        }

        renderSubs(subs);
        loadPayments();
      } catch (err) {
        document.getElementById('subsList').innerHTML = '<div class="empty-state"><h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3><p>' + err.message + '</p></div>';
      }
    }

    function renderSubs(subs) {
      var container = document.getElementById('subsList');
      if (!subs || subs.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</h3><p>–ö—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p><a href="/tariffs" class="btn btn-primary">–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</a></div>';
        return;
      }

      container.innerHTML = subs.map(function(sub) {
        var isActive = (sub.status === 'active' || sub.status === 'trial') && new Date(sub.expires_at) > new Date();
        var days = daysUntil(sub.expires_at);
        var statusBadge = isActive
          ? '<span class="key-status-badge">‚úì Active</span>'
          : '<span class="key-status-badge expired">‚úï Expired</span>';
        var tariffName = sub.tariff ? sub.tariff.name : '–ü–æ–¥–ø–∏—Å–∫–∞';
        var trafficText = sub.traffic_limit_gb
          ? (sub.traffic_used_gb || 0).toFixed(1) + ' / ' + sub.traffic_limit_gb + ' –ì–ë'
          : (sub.traffic_used_gb || 0).toFixed(1) + ' –ì–ë';
        var devices = sub.tariff ? sub.tariff.max_devices : '---';
        var protocolTag = '<span class="key-protocol-tag">VLESS</span>';

        return '<div class="key-card">' +
          '<div class="key-card-header">' +
            '<div class="key-card-title">' + protocolTag.replace('</span>', '') + tariffName + '</span></div>' +
            statusBadge +
          '</div>' +
          (sub.subscription_url ? '<div class="key-content"><div class="key-display-value">' + sub.subscription_url + '</div></div>' : '') +
          '<div class="sub-card-stats">' +
            '<div class="sub-stat"><div class="sub-stat-value">' + days + '</div><div class="sub-stat-label">–î–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å</div></div>' +
            '<div class="sub-stat"><div class="sub-stat-value">' + trafficText + '</div><div class="sub-stat-label">–¢—Ä–∞—Ñ–∏–∫</div></div>' +
            '<div class="sub-stat"><div class="sub-stat-value">' + devices + '</div><div class="sub-stat-label">–£—Å—Ç—Ä–æ–π—Å—Ç–≤</div></div>' +
            '<div class="sub-stat"><div class="sub-stat-value">' + formatDate(sub.expires_at) + '</div><div class="sub-stat-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</div></div>' +
          '</div>' +
          '<div class="key-actions">' +
            '<button class="key-copy-btn" onclick="copyToClipboard(\'' + (sub.subscription_url || '') + '\', this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>' +
            (isActive ? '<button class="key-copy-btn" onclick="openRenew(\'' + sub.id + '\')">‚Üª –ü—Ä–æ–¥–ª–∏—Ç—å</button>' : '<button class="key-copy-btn" onclick="openRenew(\'' + sub.id + '\')">‚ü≥ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</button>') +
            '<a href="/apps" class="key-copy-btn" style="display:inline-flex;text-decoration:none;margin:0;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å</a>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function loadPayments() {
      try {
        document.getElementById('paymentsList').innerHTML = '<div class="empty-state"><p>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å</p></div>';
      } catch (e) {}
    }

    function setRenewPeriod(btn, period) {
      var modal = document.getElementById('renewModal');
      modal.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      renewPeriod = period;
      renderRenewTariffs();
    }

    function renderRenewTariffs() {
      var container = document.getElementById('renewTariffs');
      var paidTariffs = renewTariffsCache.filter(function(t) { return !t.is_trial; });
      container.innerHTML = paidTariffs.map(function(t) {
        var price = Number(t[priceFields[renewPeriod]]) || 0;
        return '<div class="card" style="margin-bottom:0.75rem;cursor:pointer;" onclick="doRenew(\'' + renewSubId + '\',\'' + t.id + '\')">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;">' +
            '<div><strong>' + t.name + '</strong><br><span style="font-size:0.85rem;color:var(--text-muted);">' + periodNames[renewPeriod] + ' / ' + t.max_devices + ' —É—Å—Ç—Ä.</span></div>' +
            '<div style="font-size:1.25rem;font-weight:700;">' + price + ' &#8381;</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function openRenew(subId) {
      renewSubId = subId;
      renewPeriod = 'monthly';
      var modal = document.getElementById('renewModal');
      var container = document.getElementById('renewTariffs');
      container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

      modal.querySelectorAll('.tab-btn').forEach(function(b, i) {
        b.classList.toggle('active', i === 0);
      });

      modal.classList.add('active');

      try {
        renewTariffsCache = await API.get('/api/tariffs');
        renderRenewTariffs();
      } catch (e) {
        container.innerHTML = '<p style="color:var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤</p>';
      }
    }

    async function doRenew(subId, tariffId) {
      try {
        await API.post('/api/subscriptions/' + subId + '/renew', { tariff_id: tariffId, period: renewPeriod });
        showToast('–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞', 'success');
        closeModal('renewModal');
        loadCabinet();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function activateTrial() {
      var btn = document.getElementById('trialBtn');
      btn.disabled = true;
      btn.textContent = '–ê–∫—Ç–∏–≤–∞—Ü–∏—è...';
      try {
        var tariffs = await API.get('/api/tariffs');
        var trial = tariffs.find(function(t) { return t.is_trial; });
        if (!trial) throw new Error('–ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        await API.post('/api/subscriptions/purchase', { tariff_id: trial.id });
        showToast('–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
        loadCabinet();
      } catch (err) {
        showToast(err.message, 'error');
        btn.disabled = false;
        btn.textContent = '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥';
      }
    }

    async function saveProfile() {
      try {
        await API.put('/api/auth/profile', {
          username: document.getElementById('profileUsername').value,
          telegram_id: document.getElementById('profileTgId').value || null,
        });
        showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', loadCabinet);
  </script>
</body>
</html>
