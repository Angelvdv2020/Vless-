# ‚ùå –û—à–∏–±–∫–∏ –≤ –≤–∞—à–µ–π Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º

```
–í–ê–® –ö–û–ù–§–ò–ì:                          –ü–†–û–ë–õ–ï–ú–ê:

upstream remnawave-subscription-page {
   server ...:3010;
}
                                     ‚ö†Ô∏è –î–£–ë–õ–ò–ö–ê–¢!
upstream remnawave-subscription-page {    ‚Üê –û–±—ä—è–≤–ª–µ–Ω –¥–≤–∞–∂–¥—ã
    server ...:3100;                      ‚Üê –†–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã!
}                                         ‚Üê Nginx —É–ø–∞–¥–µ—Ç!

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

server {
    server_name sab.servervpn.store;
    ...
    proxy_pass http://remnawave-subscription-page;  # –ø–æ—Ä—Ç 3010 ‚úì
}
                                     ‚ö†Ô∏è –î–£–ë–õ–ò–ö–ê–¢!
server {
    server_name sab.servervpn.store; ‚Üê –¢–æ—Ç –∂–µ –¥–æ–º–µ–Ω!
    ...
    proxy_pass http://remnawave;     ‚Üê –î—Ä—É–≥–æ–π –ø–æ—Ä—Ç (3000)!
}                                    ‚Üê –ö–æ–Ω—Ñ–ª–∏–∫—Ç!

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

server {
    listen 443 ssl;
    server_name www.servervpn.store;
    return 301 ...;
                                     ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢ }
                                     ‚Üê –ù–µ–∑–∞–∫—Ä—ã—Ç–∞—è —Å–∫–æ–±–∫–∞!

server {                             ‚Üê –°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!
    listen 443 ssl;                  ‚Üê –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞!
    ...

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                                     ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢
                                     ‚Üê –ù–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ HTTP ‚Üí HTTPS
                                     ‚Üê –ü–æ—Ä—Ç 80 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!
```

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä

### –û—à–∏–±–∫–∞ 1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ upstream

**–°—Ç—Ä–æ–∫–∏ 6-13 –≤ –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ:**

```nginx
upstream remnawave-subscription-page {
   server remnawave-subscription-page:3010;
}

upstream remnawave-subscription-page {    # ‚Üê –û—à–∏–±–∫–∞!
    server remnawave-subscription-page:3100;
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- Nginx –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥–≤–∞ upstream —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º
- –†–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã (3010 –∏ 3100) - –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Nginx –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É: `duplicate upstream "remnawave-subscription-page"`

**–†–µ—à–µ–Ω–∏–µ:**
```nginx
# –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω
upstream remnawave-subscription-page {
    server remnawave-subscription-page:3010;
}
```

---

### –û—à–∏–±–∫–∞ 2: –î–≤–∞ server –±–ª–æ–∫–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞

**–í –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ:**

```nginx
# –ë–ª–æ–∫ 1 (—Å—Ç—Ä–æ–∫–∏ 90-150)
server {
    server_name sab.servervpn.store;
    listen 443 ssl;
    proxy_pass http://remnawave-subscription-page;  # ‚Üí :3010 ‚úì
}

# –ë–ª–æ–∫ 2 (—Å—Ç—Ä–æ–∫–∏ 152-210)
server {
    server_name sab.servervpn.store;                # ‚Üê –¢–æ—Ç –∂–µ –¥–æ–º–µ–Ω!
    listen 443 ssl reuseport;
    proxy_pass http://remnawave;                    # ‚Üí :3000 ‚úó
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- –î–≤–∞ —Ä–∞–∑–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
- Nginx –Ω–µ –∑–Ω–∞–µ—Ç –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–ø–æ—Ä—Ç 3010)
- –í—Ç–æ—Ä–æ–π –±–ª–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç (–ø–æ—Ä—Ç 3000 - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!)

**–†–µ—à–µ–Ω–∏–µ:**
```nginx
# –£–¥–∞–ª–∏—Ç—å –≤—Ç–æ—Ä–æ–π –±–ª–æ–∫, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π
server {
    server_name sab.servervpn.store;
    proxy_pass http://remnawave-subscription-page;  # :3010
}
```

---

### –û—à–∏–±–∫–∞ 3: –ù–µ–∑–∞–∫—Ä—ã—Ç–∞—è —Ñ–∏–≥—É—Ä–Ω–∞—è —Å–∫–æ–±–∫–∞

**–í –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ (—Å—Ç—Ä–æ–∫–∞ ~213):**

```nginx
server {
    listen 443 ssl;
    server_name www.servervpn.store;
    return 301 https://servervpn.store$request_uri;
}                                                    # ‚Üê –¢—É—Ç —Å–∫–æ–±–∫–∞ –µ—Å—Ç—å

server {                                             # ‚Üê –ù–æ –µ–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç!
    listen 443 ssl;
```

**–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–µ–¥—ã–¥—É—â–∏–π –±–ª–æ–∫ –¥–ª—è `sab.servervpn.store` –Ω–µ –∑–∞–∫—Ä—ã—Ç!

**–†–µ—à–µ–Ω–∏–µ:**
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —É –∫–∞–∂–¥–æ–≥–æ `server {` –µ—Å—Ç—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è `}`

---

### –û—à–∏–±–∫–∞ 4: –ù–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ HTTP ‚Üí HTTPS

**–í –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ:**
- –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ `listen 443 ssl` (HTTPS)
- –ù–µ—Ç `listen 80` (HTTP)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–π–¥–µ—Ç –Ω–∞ `http://panels.servervpn.store`, –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É

**–†–µ—à–µ–Ω–∏–µ:**
```nginx
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
server {
    listen 80;
    listen [::]:80;
    server_name panels.servervpn.store sab.servervpn.store servervpn.store;
    return 301 https://$host$request_uri;
}
```

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
1. upstream –±–ª–æ–∫–∏ (–ë–ï–ó –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
   ‚îú‚îÄ‚îÄ remnawave (–ø–æ—Ä—Ç 3000)
   ‚îî‚îÄ‚îÄ remnawave-subscription-page (–ø–æ—Ä—Ç 3010)

2. HTTPS —Å–µ—Ä–≤–µ—Ä—ã (port 443)
   ‚îú‚îÄ‚îÄ panels.servervpn.store ‚Üí remnawave:3000
   ‚îú‚îÄ‚îÄ sab.servervpn.store ‚Üí remnawave-subscription-page:3010
   ‚îú‚îÄ‚îÄ www.servervpn.store ‚Üí redirect –Ω–∞ servervpn.store
   ‚îî‚îÄ‚îÄ default_server ‚Üí reject

3. HTTP —Å–µ—Ä–≤–µ—Ä (port 80)
   ‚îî‚îÄ‚îÄ redirect –≤—Å–µ –¥–æ–º–µ–Ω—ã ‚Üí HTTPS
```

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
sudo cp /var/www/noryxvpn/nginx.conf /etc/nginx/sites-available/noryxvpn

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ
sudo nginx -t

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
sudo systemctl reload nginx
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª

```bash
# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
sudo cp /var/www/noryxvpn/nginx-fixed-annotated.conf /etc/nginx/sites-available/noryxvpn

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ
sudo nginx -t

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
sudo systemctl reload nginx
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å Nginx

```bash
sudo nginx -t
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–æ–≤

```bash
# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
curl -I https://panels.servervpn.store
# –û–∂–∏–¥–∞–µ—Ç—Å—è: HTTP/2 200

# Subscription page
curl -I https://sab.servervpn.store
# –û–∂–∏–¥–∞–µ—Ç—Å—è: HTTP/2 200

# HTTP ‚Üí HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç
curl -I http://panels.servervpn.store
# –û–∂–∏–¥–∞–µ—Ç—Å—è: HTTP/1.1 301 Moved Permanently
# Location: https://panels.servervpn.store/
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤

```bash
sudo netstat -tulpn | grep -E ':3000|:3010|:443|:80'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
:80     LISTEN  (nginx)
:443    LISTEN  (nginx)
:3000   LISTEN  (node - remnawave)
:3010   LISTEN  (node - subscription-page)
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ vs –ü–æ—Å–ª–µ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | ‚ùå –î–û (–≤–∞—à –∫–æ–Ω—Ñ–∏–≥) | ‚úÖ –ü–û–°–õ–ï (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) |
|----------|-------------------|---------------------|
| upstream remnawave-subscription-page | **2 –±–ª–æ–∫–∞** (3010 –∏ 3100) | **1 –±–ª–æ–∫** (3010) |
| server sab.servervpn.store | **2 –±–ª–æ–∫–∞** (–∫–æ–Ω—Ñ–ª–∏–∫—Ç) | **1 –±–ª–æ–∫** |
| HTTP ‚Üí HTTPS redirect | **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** | **–î–æ–±–∞–≤–ª–µ–Ω** |
| –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–∫–æ–±–∫–∏ | **–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç** | **–í—Å–µ –Ω–∞ –º–µ—Å—Ç–µ** |
| –°–∏–Ω—Ç–∞–∫—Å–∏—Å http2 | `http2 on;` (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π) | `listen 443 ssl http2` |

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –û—à–∏–±–∫–∞: "duplicate upstream"

```bash
nginx: [emerg] duplicate upstream "remnawave-subscription-page"
```

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É–¥–∞–ª–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç upstream

### –û—à–∏–±–∫–∞: "conflicting server name"

```bash
nginx: [warn] conflicting server name "sab.servervpn.store"
```

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–ª—è –¥–æ–º–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω server –±–ª–æ–∫

### –û—à–∏–±–∫–∞: 502 Bad Gateway

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã 3000 –∏ 3010)
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç –≤ proxy_pass

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç
sudo systemctl status noryxvpn
sudo netstat -tulpn | grep -E ':3000|:3010'
```

---

## üìÅ –§–∞–π–ª—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏

–í –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å:

1. **nginx.conf** - –ß–∏—Å—Ç–∞—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
2. **nginx-fixed-annotated.conf** - –° –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
3. **–û–®–ò–ë–ö–ò_–ò_–†–ï–®–ï–ù–ò–ï.md** - –≠—Ç–æ—Ç —Ñ–∞–π–ª (–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)
4. **NGINX_FIX.md** - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üéØ –ò—Ç–æ–≥–æ: –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
sudo cp nginx.conf /etc/nginx/sites-available/noryxvpn

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
sudo nginx -t

# 3. –ï—Å–ª–∏ –≤—Å–µ –û–ö - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ
sudo systemctl reload nginx

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É
curl -I https://panels.servervpn.store
curl -I https://sab.servervpn.store

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo tail -f /var/log/nginx/error.log
```

---

–ì–æ—Ç–æ–≤–æ! –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. üéâ
