<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Noryx VPN</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:720px;margin:30px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin-top:14px}
    button,a.btn{padding:10px 14px;border-radius:8px;border:0;background:#4f46e5;color:#fff;text-decoration:none;cursor:pointer}
    select{padding:10px;width:100%;margin:8px 0}
    pre{white-space:pre-wrap;background:#f5f5f5;padding:10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="top">
    <h1>Noryx VPN</h1>
    <div id="authActions"></div>
  </div>


  <div class="card">
    <h3>Landing Content (published from Builder)</h3>
    <div id="landingSections">Загрузка...</div>
  </div>
  <div class="card">
    <h3>Smart Connect</h3>
    <select id="countrySelect"></select>
    <button id="connectButton">Подключить VPN</button>
    <div id="result" style="margin-top:10px"></div>
  </div>

<script>
const API_URL = window.location.origin + '/api/vpn';
const session = JSON.parse(localStorage.getItem('vpn_session') || 'null');

function authHeader() {
  const token = session?.token;
  return token ? { Authorization: `Bearer ${token}` } : {};
}

function renderAuth() {
  const el = document.getElementById('authActions');
  if (!session?.token) {
    el.innerHTML = '<a class="btn" href="/login.html">Войти</a> <a class="btn" href="/register.html">Регистрация</a>';
    return;
  }
  const role = session.user?.role;
  if (role === 'admin') {
    el.innerHTML = '<a class="btn" href="/admin.html">Админ</a> <a class="btn" href="/builder.html">Конструктор</a> <button onclick="logout()">Выйти</button>';
  } else {
    el.innerHTML = '<a class="btn" href="/cabinet.html">ЛК</a> <button onclick="logout()">Выйти</button>';
  }
}

function logout(){ localStorage.removeItem('vpn_session'); location.reload(); }


async function loadLandingSections() {
  const box = document.getElementById('landingSections');
  try {
    const res = await fetch('/api/site-content/published');
    const data = await res.json();
    const items = data.items || [];
    box.innerHTML = items.map(item => `<div style="margin-bottom:10px"><b>${item.section_key}</b>: ${item.title}<br><span style="color:#555">${item.body || ''}</span></div>`).join('') || 'Нет опубликованного контента';
  } catch (e) {
    box.textContent = 'Не удалось загрузить опубликованный контент';
  }
}
async function loadCountries() {
  const select = document.getElementById('countrySelect');
  select.innerHTML = '<option>Загрузка...</option>';
  const res = await fetch(`${API_URL}/countries`);
  const data = await res.json();
  select.innerHTML = (data.countries || []).map(c => `<option value="${c.country_code}">${c.flag_emoji || ''} ${c.country_name}</option>`).join('');
}

async function smartConnect() {
  const result = document.getElementById('result');
  if (!session?.token) {
    result.textContent = 'Сначала войдите в аккаунт';
    return;
  }

  const countryCode = document.getElementById('countrySelect').value || 'auto';
  const res = await fetch(`${API_URL}/connect`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeader() },
    body: JSON.stringify({ countryCode })
  });
  const data = await res.json();
  if (!res.ok) {
    result.innerHTML = `<b>Ошибка:</b> ${data.error || 'failed'}`;
    return;
  }

  let html = `<div><b>Готово</b> (${data.deliveryFormat})</div>`;
  if (data.deepLink) html += `<div><a class="btn" href="${data.deepLink}">Открыть приложение</a></div>`;
  if (data.downloadUrl) html += `<div><a class="btn" href="${data.downloadUrl}">Скачать файл</a></div>`;
  if (data.qrCode) html += `<div><img src="${data.qrCode}" width="220"/></div>`;
  result.innerHTML = html;
}

document.getElementById('connectButton').addEventListener('click', smartConnect);
renderAuth();
loadCountries();
loadLandingSections();
</script>
</body>
</html>
