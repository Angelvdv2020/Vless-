# Аутентификация Администратора Noryx

## Обзор

Администраторская панель Noryx использует **JWT-токен** для аутентификации.

Это **отдельная система** от пользовательских подписок RemnaWave.

### Ключевые отличия

| Параметр | Пользователь VPN | Администратор Noryx |
|---|---|---|
| Аутентификация | Email + пароль в Supabase | Admin password → JWT |
| Хранилище | БД (Supabase) | Переменная окружения |
| Доступ | API RemnaWave | Admin panel (admin.html) |
| Область | Управление подписками | Управление системой |

---

## Процесс входа администратора

### Шаг 1: Отправка пароля админа

Admin panel (admin.html) отправляет POST запрос:

```http
POST /api/admin/auth/login HTTP/1.1
Content-Type: application/json

{
  "password": "твой_админ_пароль"
}
```

### Шаг 2: Сервер генерирует JWT

Если пароль совпадает с `ADMIN_PASSWORD` в `.env`:

```javascript
// src/routes/admin.js - /login endpoint
const token = jwt.sign(
  { role: 'admin' },
  process.env.JWT_SECRET,
  { expiresIn: '24h' }
);

res.json({ token });
```

### Шаг 3: Клиент сохраняет JWT

Admin.html получает токен и сохраняет в localStorage:

```javascript
localStorage.setItem('adminToken', token);
```

### Шаг 4: JWT используется в запросах

Все последующие запросы включают JWT:

```http
GET /api/admin/stats HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Шаг 5: Сервер проверяет JWT

Middleware `adminAuth` проверяет токен:

```javascript
// src/middleware/adminAuth.js
const token = authHeader.substring(7);  // убрать "Bearer "
jwt.verify(token, process.env.JWT_SECRET); // проверить подпись
// ✅ Если верно → next()
// ❌ Если неверно → 401 Unauthorized
```

---

## Конфигурация

### Переменные окружения

```env
# .env
ADMIN_PASSWORD=ваш_надежный_пароль
JWT_SECRET=ваш_секретный_ключ_для_подписи
```

### Требования

- `ADMIN_PASSWORD` — пароль для входа в админ-панель
- `JWT_SECRET` — секретный ключ для подписи JWT (минимум 32 символа)

---

## Использование Admin Panel

### Вход

1. Откройте `http://localhost:3000/admin.html`
2. Введите `ADMIN_PASSWORD` из `.env`
3. Нажмите **Login**

### После входа

Доступны разделы:

- **Dashboard** — статистика
- **Users** — список всех пользователей
- **Subscriptions** — управление подписками
- **Countries** — включение/отключение стран
- **Connection Logs** — логи подключений

### Действия

- **Renew Subscription** — продлить подписку пользователя
- **Cancel Subscription** — отменить подписку
- **Toggle Country** — включить/отключить страну
- **Grant Trial** — выдать пробный период

---

## Защита и безопасность

### Как это защищено?

1. **JWT проверка** — токен подписан с `JWT_SECRET`
2. **Срок действия** — токен действует 24 часа
3. **Bearer Authorization** — стандартный HTTP заголовок
4. **HTTPS** — должно использоваться в продакшене

### Что делать при компрометации?

**Если пароль админа утёкся:**

1. Измените `ADMIN_PASSWORD` в `.env`
2. Перезагрузите сервер: `npm restart`
3. Все старые JWT автоматически станут невалидными

**Если нужно срочно заблокировать доступ:**

1. Откомпилируйте `JWT_SECRET` в `.env`
2. Перезагрузите сервер
3. Все JWT станут недействительными

---

## API Endpoints

### Аутентификация

```http
POST /api/admin/auth/login
Content-Type: application/json

{
  "password": "admin_password"
}

Response:
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 86400
}
```

### Статистика (требует JWT)

```http
GET /api/admin/stats
Authorization: Bearer {token}

Response:
{
  "totalUsers": 1234,
  "activeSubscriptions": 567,
  "connectionsLast24h": 8901,
  "topCountries": [...],
  "platforms": [...]
}
```

### Пользователи (требует JWT)

```http
GET /api/admin/users
Authorization: Bearer {token}

Response: [
  { "id": 1, "email": "user@example.com", ... },
  ...
]
```

### Подписки (требует JWT)

```http
GET /api/admin/subscriptions
Authorization: Bearer {token}

PATCH /api/admin/subscriptions/{id}/renew
Authorization: Bearer {token}
Content-Type: application/json

{
  "days": 30
}

PATCH /api/admin/subscriptions/{id}/cancel
Authorization: Bearer {token}

POST /api/admin/subscriptions/grant-trial
Authorization: Bearer {token}
Content-Type: application/json

{
  "userId": 123,
  "days": 7
}
```

### Страны (требует JWT)

```http
GET /api/admin/countries
Authorization: Bearer {token}

PATCH /api/admin/countries/{code}/toggle
Authorization: Bearer {token}
```

### Логи (требует JWT)

```http
GET /api/admin/connection-logs
Authorization: Bearer {token}
```

---

## Troubleshooting

### «Invalid admin credentials»

**Причина:** Введён неправильный пароль.

**Решение:** Проверьте `ADMIN_PASSWORD` в `.env`.

### «Admin authentication required»

**Причина:** Нет токена в заголовке `Authorization`.

**Решение:** Убедитесь, что вы залогинены и JWT сохранён в localStorage.

### «Token expired»

**Причина:** JWT действителен только 24 часа.

**Решение:** Заново введите пароль для получения новой ссылки.

### Logout не работает

**Причина:** Токен ещё в памяти браузера.

**Решение:**
1. Очистите localStorage: `localStorage.clear()`
2. Закройте вкладку и откройте заново

---

## Интеграция с системой

### Для разработчиков

Если вы хотите добавить новый admin endpoint:

```javascript
// src/routes/admin.js

// 1. Добавить маршрут с middleware adminAuth
router.get('/my-endpoint', async (req, res) => {
  // adminAuth уже проверил JWT
  // req.admin содержит расшифрованный JWT payload

  res.json({ data: 'только для админов' });
});
```

### Для DevOps

При деплое на production:

1. Установите сильный `ADMIN_PASSWORD` (минимум 16 символов)
2. Установите сложный `JWT_SECRET` (минимум 32 символа)
3. Используйте HTTPS для всех запросов
4. Регулярно ротируйте `JWT_SECRET`

---

## Лучшие практики

✅ **Делай:**
- Используй сильный пароль админа
- Регулярно меняй JWT_SECRET
- Используй HTTPS в продакшене
- Логируй попытки входа

❌ **Не делай:**
- Не используй простые пароли типа «admin» или «123456»
- Не делишься админ-паролем с неавторизованными лицами
- Не сохраняй JWT_SECRET в git
- Не используй один JWT_SECRET для разных окружений

---

## Примеры curl

### Вход

```bash
curl -X POST http://localhost:3000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "password": "ваш_админ_пароль"
  }'
```

### Получить статистику

```bash
curl -X GET http://localhost:3000/api/admin/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Получить пользователей

```bash
curl -X GET http://localhost:3000/api/admin/users \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```
