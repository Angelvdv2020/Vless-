# 🏗️ АРХИТЕКТУРА: 3 СЕРВЕРА

## 📊 Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│              СЕРВЕР 1: VPS (servervpn.store)                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Node.js + Express (port 3000)                           │   │
│  │  • API endpoints для клиентов                            │   │
│  │  • Интеграция с RemnaWave                                │   │
│  │  • Интеграция с платежными системами                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  PostgreSQL 15                                           │   │
│  │  • Пользователи                                          │   │
│  │  • Подписки                                              │   │
│  │  • Платежи                                               │   │
│  │  • Сессии                                                │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Nginx (80/443)                                          │   │
│  │  • SSL сертификаты (Let's Encrypt)                       │   │
│  │  • Reverse proxy → Node.js                               │   │
│  │  • Статические файлы                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                             ↕ HTTPS API
┌─────────────────────────────────────────────────────────────────┐
│         СЕРВЕР 2: REMNAWAVE (panels.servervpn.store)            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Docker: RemnaWave Backend (port 3000)                   │   │
│  │  • Управление VPN серверами                              │   │
│  │  • XRay конфигурация                                     │   │
│  │  • API для интеграции                                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Docker: PostgreSQL                                      │   │
│  │  • Техническая БД RemnaWave                              │   │
│  │  • Конфигурации серверов                                 │   │
│  │  • Inbounds, клиенты                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Docker: Caddy (80/443)                                  │   │
│  │  • Автоматические SSL от Let's Encrypt                   │   │
│  │  • Reverse proxy → Backend                               │   │
│  │  • HTTP/2 и HTTP/3                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                             ↕ HTTPS API
┌─────────────────────────────────────────────────────────────────┐
│    СЕРВЕР 3: SUBSCRIPTION PAGE (sab.servervpn.store)            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Docker: Node.js App (port 3010)                         │   │
│  │  • Публичная страница подписки                           │   │
│  │  • "Умная кнопка" подключения                            │   │
│  │  • Определение платформы                                 │   │
│  │  • QR коды                                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Docker: Caddy (80/443)                                  │   │
│  │  • Автоматические SSL от Let's Encrypt                   │   │
│  │  • Reverse proxy → App                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 Почему именно 3 сервера?

### Техническая необходимость

**RemnaWave Panel** работает в Docker с **встроенным Caddy**, который:
- Занимает порты **80 и 443**
- Автоматически получает SSL от Let's Encrypt
- Не может быть заменен на Nginx
- Является частью официальной конфигурации

**Это означает:**
- ❌ На Сервере 2 нельзя запустить другой веб-сервер
- ❌ Subscription Page не может быть на Сервере 2
- ✅ Нужен отдельный Сервер 3 для Subscription Page

### Преимущества архитектуры

1. **Изоляция компонентов**
   - Каждый сервер выполняет свою роль
   - Падение одного не ломает другие
   - Легко обновлять каждый компонент отдельно

2. **Безопасность**
   - RemnaWave изолирован (доступ только с Сервера 1)
   - Subscription Page публичен, но изолирован от БД
   - Разделение приватного и публичного контента

3. **Масштабируемость**
   - Легко добавить больше Subscription серверов
   - Можно использовать load balancer
   - Каждый сервер масштабируется независимо

4. **Производительность**
   - Нагрузка распределена между серверами
   - Subscription Page не перегружает основной VPS
   - RemnaWave работает без конкуренции за ресурсы

## 📦 Требования к серверам

| Сервер | CPU | RAM | Диск | Bandwidth | ОС |
|--------|-----|-----|------|-----------|-----|
| **Сервер 1 (VPS)** | 2 vCPU | 4 GB | 40 GB SSD | 1 Gbps | Ubuntu 22.04 LTS |
| **Сервер 2 (RemnaWave)** | 2 vCPU | 2 GB | 20 GB SSD | 100 Mbps | Ubuntu 22.04 LTS |
| **Сервер 3 (Subscription)** | 1 vCPU | 1 GB | 10 GB SSD | 100 Mbps | Ubuntu 22.04 LTS |

## 🔗 Схема взаимодействия

### Workflow: Создание подписки

```
Пользователь → Сервер 1 (API)
                    ↓
          1. Создать пользователя в PostgreSQL
                    ↓
          2. Запрос к RemnaWave (Сервер 2)
             "Создать VPN ключ"
                    ↓
          3. RemnaWave создает ключ
                    ↓
          4. Сервер 1 сохраняет subscription_uuid
                    ↓
          5. Возврат short_uuid пользователю
                    ↓
Пользователь открывает: sab.servervpn.store/{short_uuid}
                    ↓
          Сервер 3 → API Сервера 1
             "Получить данные подписки"
                    ↓
          Сервер 3 отображает страницу
          с умной кнопкой и QR кодом
```

### Связь между серверами

```
Сервер 1 ←→ Сервер 2 (RemnaWave)
   • Создание VPN ключей
   • Удаление ключей
   • Получение статуса
   • Синхронизация серверов
   • Авторизация: REMNAWAVE_API_TOKEN

Сервер 1 ←→ Сервер 3 (Subscription)
   • Получение данных подписки
   • Авторизация: SUBSCRIPTION_API_TOKEN
```

## 🔐 Безопасность

### Firewall правила

**Сервер 1:**
```bash
ufw allow ssh          # SSH
ufw allow 80/tcp       # HTTP (redirect)
ufw allow 443/tcp      # HTTPS
ufw default deny incoming
```

**Сервер 2:**
```bash
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
# КРИТИЧЕСКИ ВАЖНО: разрешить доступ только с Сервера 1!
ufw allow from SERVER_1_IP to any port 443
ufw default deny incoming
```

**Сервер 3:**
```bash
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw default deny incoming
```

### API токены

1. **REMNAWAVE_API_TOKEN**
   - Для связи Сервер 1 ↔ Сервер 2
   - Должен совпадать в .env на обоих серверах
   - Генерация: `openssl rand -hex 32`

2. **SUBSCRIPTION_API_TOKEN**
   - Для связи Сервер 1 ↔ Сервер 3
   - Должен совпадать в .env на обоих серверах
   - Генерация: `openssl rand -hex 32`

## 📊 Сравнение вариантов

### Вариант 1: Все на 1 сервере

```
❌ НЕВОЗМОЖНО
VPS + RemnaWave на одном сервере
→ Конфликт портов 80/443 (Nginx vs Caddy)
```

### Вариант 2: На 2 серверах

```
⚠️ ПРОБЛЕМАТИЧНО
Сервер 1: VPS + Subscription Page
Сервер 2: RemnaWave

Проблемы:
- Перегруз Сервера 1 при большом трафике
- Смешивание публичного и приватного контента
- Сложнее масштабировать
```

### Вариант 3: На 3 серверах ✅

```
✅ ОПТИМАЛЬНО
Сервер 1: VPS (приватный API)
Сервер 2: RemnaWave (изолирован)
Сервер 3: Subscription (публичный)

Преимущества:
✅ Нет конфликтов портов
✅ Изоляция компонентов
✅ Легко масштабируется
✅ Production ready
```

## 🚀 API Endpoints

### Сервер 1 (VPS)

**Публичные:**
- `POST /api/auth/register` - Регистрация
- `POST /api/auth/login` - Вход
- `GET /api/tariffs` - Список тарифов
- `GET /api/public/sub/:uuid` - Данные подписки (для Сервера 3)

**Приватные (требуют JWT):**
- `GET /api/subscriptions` - Подписки пользователя
- `POST /api/vpn/activate` - Активировать VPN
- `DELETE /api/vpn/deactivate` - Деактивировать VPN

**Внутренние (между серверами):**
- `GET /api/remnawave/servers` - Синхронизация серверов
- `POST /api/remnawave/create-key` - Создать VPN ключ
- `DELETE /api/remnawave/delete-key` - Удалить VPN ключ

### Сервер 2 (RemnaWave)

**API (требует REMNAWAVE_API_TOKEN):**
- `GET /api/servers` - Список серверов
- `GET /api/inbounds` - Список inbounds
- `POST /api/users` - Создать пользователя
- `DELETE /api/users/:id` - Удалить пользователя
- `GET /api/users/:id/subscription` - Subscription link

### Сервер 3 (Subscription Page)

**Публичные:**
- `GET /health` - Health check
- `GET /:uuid` - Страница подписки (HTML)
- `GET /api/sub/:uuid` - Данные подписки (JSON)

## ✅ Итого

**Архитектура на 3 серверах** - единственное правильное решение для данной задачи:

✅ Соответствует технической архитектуре RemnaWave
✅ Изолирует компоненты для безопасности
✅ Обеспечивает масштабируемость
✅ Production ready

**Следующие шаги:** См. `3_SERVERS_INSTALLATION_GUIDE.md`
